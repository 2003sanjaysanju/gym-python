<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POWER HOUSE</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="page-header">
        <div class="brand">
            <img src="assets/logo.png"
                 data-fallback="assets/logo-placeholder.svg"
                 alt="Power House Gym logo"
                 class="brand-logo">
            <div>
                <h1>POWER HOUSE Monitoring Dashboard</h1>
                <p>Track member admissions, fee plans, and upcoming payments.</p>
            </div>
        </div>
        <nav class="actions">
            <a class="action-button" href="#member-form">Add Member</a>
            <a class="action-button secondary" href="#members-table">View Members</a>
            <button class="action-button subtle" type="button" data-action="clear-storage">Clear Local Data</button>
        </nav>
    </header>

    <main>
        <section class="cards" id="summary">
            <article class="card">
                <h2>Total Members</h2>
                <p id="summary-total">0</p>
            </article>
            <article class="card warning">
                <h2>Due Soon</h2>
                <p id="summary-due-soon">0</p>
            </article>
            <article class="card danger">
                <h2>Overdue</h2>
                <p id="summary-overdue">0</p>
            </article>
        </section>

        <section class="panel">
            <h2>Add Member</h2>
            <form id="member-form" class="form-grid">
                <label>
                    Name
                    <input type="text" name="name" required>
                </label>
                <label>
                    Phone
                    <input type="tel" name="phone" placeholder="Optional">
                </label>
                <label>
                    Admission Date
                    <input type="date" name="admissionDate" required>
                </label>
                <label>
                    Plan Length (months)
                    <input type="number" name="planMonths" min="1" value="1" required>
                </label>
                <label>
                    Fee Amount
                    <input type="number" name="feeAmount" min="0" step="0.01" required>
                </label>
                <button type="submit" class="primary">Add Member</button>
            </form>
        </section>

        <section class="panel">
            <div class="panel-header">
                <h2>Members</h2>
                <div class="filters">
                    <label class="search-field">
                        <span class="visually-hidden">Search members</span>
                        <input
                            type="search"
                            id="filter-query"
                            placeholder="Search name or phone"
                            autocomplete="off"
                        >
                    </label>
                    <label>
                        Show
                        <select id="filter-status">
                            <option value="all">All</option>
                            <option value="due-soon">Due soon</option>
                            <option value="overdue">Overdue</option>
                        </select>
                    </label>
                </div>
            </div>
            <div class="table-wrapper">
                <table id="members-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Admission</th>
                            <th>Plan (months)</th>
                            <th>Fee</th>
                            <th>Next Due</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <p class="empty" id="empty-state">No members yet. Add one above.</p>
            </div>
        </section>
    </main>

    <footer class="page-footer">
        <p>Data is stored locally in your browser. Export/backup support coming soon.</p>
    </footer>

    <script>
    const STORAGE_KEY = "gym-monitoring-members";

    const form = document.getElementById("member-form");
    const tableBody = document.querySelector("#members-table tbody");
    const filterSelect = document.getElementById("filter-status");
    const filterQuery = document.getElementById("filter-query");
    const emptyState = document.getElementById("empty-state");
    const summaryTotal = document.getElementById("summary-total");
    const summaryDueSoon = document.getElementById("summary-due-soon");
    const summaryOverdue = document.getElementById("summary-overdue");
    const clearButton = document.querySelector('[data-action="clear-storage"]');

    const todayISO = new Date().toISOString().split("T")[0];
    form.elements["admissionDate"].value = todayISO;

    form.addEventListener("submit", (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        const member = {
            id: crypto.randomUUID(),
            name: formData.get("name").trim(),
            phone: formData.get("phone").trim(),
            admissionDate: formData.get("admissionDate"),
            planMonths: Number(formData.get("planMonths")),
            feeAmount: Number(formData.get("feeAmount")),
            nextDue: addMonths(formData.get("admissionDate"), Number(formData.get("planMonths"))),
            createdAt: new Date().toISOString(),
        };

        if (!member.name) {
            alert("Name is required.");
            return;
        }

        const members = loadMembers();
        members.push(member);
        saveMembers(members);
        form.reset();
        form.elements["admissionDate"].value = todayISO;
        render();
    });

    filterSelect.addEventListener("change", render);
    if (filterQuery) {
        filterQuery.addEventListener("input", () => window.requestAnimationFrame(render));
    }

    const logo = document.querySelector(".brand-logo");
    if (logo) {
        const fallbackSrc = logo.dataset.fallback;
        logo.addEventListener("error", () => {
            if (fallbackSrc && logo.dataset.fallbackApplied !== "true") {
                logo.dataset.fallbackApplied = "true";
                logo.src = fallbackSrc;
            } else {
                logo.classList.add("hidden");
            }
        });
    }

    if (clearButton) {
        clearButton.addEventListener("click", () => {
            const members = loadMembers();
            if (!members.length) {
                alert("Nothing to clear yet — add a member first.");
                return;
            }
            if (confirm("This will remove all locally saved members. Continue?")) {
                localStorage.removeItem(STORAGE_KEY);
                render();
            }
        });
    }

    function loadMembers() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) {
                return [];
            }
            return JSON.parse(raw);
        } catch (error) {
            console.error("Failed to load members", error);
            return [];
        }
    }

    function saveMembers(members) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(members));
    }

    function render() {
        const members = loadMembers();
        const filter = filterSelect.value;
        const query = filterQuery ? filterQuery.value.trim().toLowerCase() : "";
        let filtered = members.filter((member) => {
            const status = computeStatus(member.nextDue);
            if (filter === "due-soon") {
                return status.code === "due-soon";
            }
            if (filter === "overdue") {
                return status.code === "overdue";
            }
            return true;
        });

        if (query) {
            filtered = filtered.filter((member) => {
                const haystack = `${member.name} ${member.phone || ""}`.toLowerCase();
                return haystack.includes(query);
            });
        }

        tableBody.innerHTML = "";
        filtered.sort((a, b) => new Date(a.nextDue) - new Date(b.nextDue));

        filtered.forEach((member) => {
            const status = computeStatus(member.nextDue);
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${member.id.slice(0, 8)}</td>
                <td>${escapeHtml(member.name)}</td>
                <td>${escapeHtml(member.phone || "-")}</td>
                <td>${member.admissionDate}</td>
                <td>${member.planMonths}</td>
                <td>₹${member.feeAmount.toFixed(2)}</td>
                <td>${member.nextDue}</td>
                <td><span class="status ${status.code}">${status.label}</span></td>
                <td>
                    <button class="link" data-action="record-payment" data-id="${member.id}">Record Payment</button>
                    <button class="link danger" data-action="delete" data-id="${member.id}">Delete</button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        if (!members.length) {
            emptyState.textContent = "No members yet. Add one above.";
            emptyState.hidden = false;
        } else if (!filtered.length) {
            emptyState.textContent = "No members match the current filter.";
            emptyState.hidden = false;
        } else {
            emptyState.hidden = true;
        }
        summaryTotal.textContent = members.length;
        summaryDueSoon.textContent = members.filter((m) => computeStatus(m.nextDue).code === "due-soon").length;
        summaryOverdue.textContent = members.filter((m) => computeStatus(m.nextDue).code === "overdue").length;
    }

    tableBody.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-action]");
        if (!button) {
            return;
        }
        const memberId = button.dataset.id;
        const action = button.dataset.action;
        const members = loadMembers();
        const member = members.find((m) => m.id === memberId);
        if (!member) {
            return;
        }

        if (action === "delete") {
            if (confirm(`Delete ${member.name}?`)) {
                saveMembers(members.filter((m) => m.id !== memberId));
                render();
            }
            return;
        }

        if (action === "record-payment") {
            const paidOn = prompt("Payment date (YYYY-MM-DD)", new Date().toISOString().split("T")[0]);
            if (!paidOn) {
                return;
            }
            if (!/^\d{4}-\d{2}-\d{2}$/.test(paidOn)) {
                alert("Invalid date. Use YYYY-MM-DD format.");
                return;
            }
            const amount = prompt("Amount received", member.feeAmount);
            if (amount === null) {
                return;
            }
            const parsedAmount = Number(amount);
            if (Number.isNaN(parsedAmount)) {
                alert("Amount must be a number.");
                return;
            }
            member.nextDue = addMonths(member.nextDue, member.planMonths);
            saveMembers(members);
            render();
        }
    });

    function computeStatus(nextDue) {
        const today = new Date();
        const due = new Date(nextDue + "T00:00:00");
        const diff = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
        if (diff < 0) {
            return { code: "overdue", label: "Overdue" };
        }
        if (diff <= 3) {
            return { code: "due-soon", label: "Due Soon" };
        }
        return { code: "ok", label: "OK" };
    }

    function addMonths(startIso, months) {
        const [year, month, day] = startIso.split("-").map(Number);
        const base = new Date(year, month - 1 + months, 1);
        const lastDay = new Date(base.getFullYear(), base.getMonth() + 1, 0).getDate();
        const clampedDay = Math.min(day, lastDay);
        const result = new Date(base.getFullYear(), base.getMonth(), clampedDay);
        return result.toISOString().split("T")[0];
    }

    function escapeHtml(value) {
        return String(value ?? "").replace(/[&<>"']/g, (char) => {
            const map = {
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
            };
            return map[char] || char;
        });
    }

    render();
    </script>
</body>
</html>
